{% extends "base.html" %}
{% block title %}{{ track.title }} - Django Music App{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card text-bg-dark mb-4">
        {% if track.cover_image %}
          <img src="{{ track.cover_image.url }}" class="card-img-top" alt="{{ track.title }}" style="height: 300px; object-fit: cover;">
        {% else %}
          <img src="/media/default_cover.jpg" class="card-img-top" alt="No cover" style="height: 300px; object-fit: cover;">
        {% endif %}

        <div class="card-body text-center">
          <h3 class="card-title">{{ track.title }}</h3>
          <p class="card-text text-muted">{{ track.artist.name|default:track.artist }}</p>

          {% if track.audio_file %}
            <audio controls class="w-100 mt-3">
              <source src="{{ track.audio_file.url }}" type="audio/mpeg">
              TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ phÃ¡t nháº¡c.
            </audio>
          {% endif %}

          <!-- ThÃªm/Bá» yÃªu thÃ­ch -->
          {% if user.is_authenticated %}
            <form method="post" action="{% url 'add_favorite' %}" class="mt-3">
              {% csrf_token %}
              {{ favorite_form.as_p }}
              {% if is_favorite %}
                <button type="submit" class="btn btn-danger btn-sm">ğŸ’” Bá» yÃªu thÃ­ch</button>
              {% else %}
                <button type="submit" class="btn btn-success btn-sm">â¤ï¸ ThÃªm yÃªu thÃ­ch</button>
              {% endif %}
            </form>
          {% endif %}

          <!-- Playlist -->
          {% if user.is_authenticated %}
            <div class="mt-4">
              <label for="playlistSelect" class="form-label">ThÃªm vÃ o playlist:</label>
              <form method="post" id="playlistForm">
                <select class="form-select mb-2" id="playlistSelect" name="playlist_id">
                  <option value="">-- Chá»n playlist --</option>
                  {% for playlist in playlists %}
                    <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                  {% endfor %}
                </select>

                <input type="text" class="form-control mb-2" id="newPlaylistName" name="new_playlist_name" placeholder="Hoáº·c táº¡o playlist má»›i">

                <button type="submit" class="btn btn-success btn-sm">ThÃªm vÃ o playlist</button>
              </form>
            </div>
          {% endif %}

        </div>
      </div>

    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // HÃ m láº¥y CSRF tá»« cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  const playlistForm = document.getElementById('playlistForm');
  const playlistSelect = document.getElementById('playlistSelect');
  const newPlaylistInput = document.getElementById('newPlaylistName');
  const trackId = {{ track.id }};

  if (playlistForm) {
    playlistForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const playlistId = playlistSelect.value;
      const newPlaylistName = newPlaylistInput.value.trim();

      let url = '';
      let data = { song_id: trackId };

      if (newPlaylistName) {
        data.new_playlist_name = newPlaylistName;
        url = '/playlist/add-to-user/0/0/';  // server dÃ¹ng JSON body
      } else if (playlistId) {
        url = `/playlist/add-to-user/${trackId}/${playlistId}/`;
      } else {
        alert('Vui lÃ²ng chá»n playlist hoáº·c nháº­p tÃªn playlist má»›i.');
        return;
      }

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          alert(res.message);
          playlistSelect.value = '';
          newPlaylistInput.value = '';
        } else {
          alert(res.message || 'CÃ³ lá»—i xáº£y ra!');
        }
      })
      .catch(err => {
        console.error(err);
        alert('CÃ³ lá»—i xáº£y ra khi thÃªm vÃ o playlist!');
      });
    });
  }
});
</script>
{% endblock %}
