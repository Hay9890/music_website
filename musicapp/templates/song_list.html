{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">Danh sách nhạc</h2>

<div class="row row-cols-1 row-cols-md-3 g-4">
  {% for song in songs %}
    <div class="col">
      <div class="card h-100 shadow-sm text-bg-dark">
        {% if song.cover_image %}
          <img src="{{ song.cover_image.url }}" class="card-img-top" style="height:200px; object-fit:cover;">
        {% else %}
<<<<<<< HEAD
          <img src="/music_web/media/default_cover.jpg" class="card-img-top" style="height:200px; object-fit:cover;">
=======
          <img src="/media/default_cover.jpg" class="card-img-top" style="height:200px; object-fit:cover;">
>>>>>>> ea517f31d8db99d64a150fa0664ea3eb71c2c436
        {% endif %}
        <div class="card-body text-center">
          <h5 class="card-title">{{ song.title }}</h5>
          <p class="card-text text-muted">{{ song.artist }}</p>
          {% if song.audio_file %}
            <audio controls class="w-100 mt-2">
              <source src="{{ song.audio_file.url }}" type="audio/mpeg">
            </audio>
          {% endif %}
          <div class="mt-3">
            <button type="button" class="btn btn-danger btn-sm add-fav-btn" data-song-id="{{ song.id }}">
              ❤️ Yêu thích
            </button>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="text-center text-muted">Chưa có bài hát nào.</p>
  {% endfor %}
</div>

<!-- MODAL TẠO FAVORITE -->
<div class="modal fade" id="favModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Tạo danh sách yêu thích mới</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="favSongId">
        <div class="mb-3">
          <label for="newFavName" class="form-label">Tên danh sách yêu thích</label>
          <input type="text" class="form-control" id="newFavName" placeholder="Nhập tên danh sách">
        </div>
        <button type="button" class="btn btn-danger w-100" id="saveFavBtn">Thêm</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const favModal = new bootstrap.Modal(document.getElementById('favModal'));

  // Hiển thị modal khi nhấn trái tim
  document.querySelectorAll('.add-fav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('favSongId').value = btn.dataset.songId;
      document.getElementById('newFavName').value = '';
      favModal.show();
    });
  });

  // Thêm bài hát vào danh sách yêu thích
  document.getElementById('saveFavBtn').addEventListener('click', () => {
    const songId = document.getElementById('favSongId').value;
    const favName = document.getElementById('newFavName').value.trim();

    if (!favName) {
      alert('Bạn phải nhập tên danh sách yêu thích!');
      return;
    }

    fetch(`/favorite/add/${songId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ new_fav_name: favName })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      favModal.hide();
    });
  });
});
</script>
{% endblock %}
